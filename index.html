<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whatcom County border crossing wait times</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            background: linear-gradient(to bottom right, #4a90e2, #e74c3c);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        Whatcom County border crossing wait times
                    </h1>
                    <p class="text-gray-600">A free and simple tool to track all of Whatcom County, Washington's border crossing wait times â€” in both directions 
                        <img src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/svg/1f1fa-1f1f8.svg" width="16" height="16" alt="US Flag" class="inline-block">
                        <img src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/svg/1f1e8-1f1e6.svg" width="16" height="16" alt="Canada Flag" class="inline-block">
                    </p>
                    <p class="text-sm mt-2">
                        <a href="#how-it-works" class="text-blue-600 hover:text-blue-800 underline">How it works</a>
                    </p>
                </div>
                <button onclick="fetchData()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            
            <div id="lastUpdate" class="flex items-center gap-2 text-sm text-gray-500 hidden">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Last checked: <span id="updateTime"></span>
            </div>

            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-800 font-semibold">Error loading data</p>
                <p class="text-red-600 text-sm mt-1" id="errorText"></p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="bg-white rounded-xl shadow-lg p-12 text-center">
            <svg class="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <p class="text-gray-600">Loading border wait times...</p>
        </div>

        <!-- Content - Paired Crossings -->
        <div id="content" class="hidden space-y-6">
            <!-- Pairs will be inserted here -->
        </div>

        <!-- How It Works Section -->
        <div id="how-it-works" class="mt-6 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">How it works</h2>
            <div class="text-gray-700 space-y-4">
                <p>
                    My name is Benjamin Payne, and I live in Bellingham, Washington. After having moved here in 2025, I realized that there existed no centralized portal to check wait times at all five ports of entry along the U.S-Canada border in Whatcom County. So, I designed this web app. It pulls the latest available waiting time data from both the U.S. and Canadian governments â€” plus traffic cam images and current weather conditions â€” and presents it all in a clean layout.
                </p>
                <p>
                    I will always make sure this app is free, but if you'd like, you canâ€¦
                </p>
                <div class="flex justify-center my-4">
                    <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="benjaminpayne" data-color="#FFDD00" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>
                </div>
                <p class="text-center text-sm text-gray-600">
                    (after all, this is the Pacific Northwest â˜•)
                </p>
                <p>
                    If you have any suggestions on how this tool could be improved, please feel free to <a href="mailto:benjaminthomaspayne@gmail.com" class="text-blue-600 hover:text-blue-800 underline">email me here</a>. I enjoy tinkering with the code to improve the app's look, feel, and functionality.
                </p>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4 text-center text-sm text-gray-600">
            <p class="font-semibold mb-2">Data Sources & Attribution</p>
            <p class="mb-3">App designed by Benjamin Payne. Â© 2026</p>
            <p>â€¢ U.S.-bound wait time data: U.S. Customs and Border Protection (CBP)</p>
            <p>â€¢ Canada-bound wait time data: Canada Border Services Agency (CBSA)</p>
            <p>â€¢ Traffic cam images: BC Ministry of Transportation and Transit, Washington State Department of Transportation</p>
            <p>â€¢ U.S. weather data: National Oceanic and Atmospheric Administration through Open-Meteo.com</p>
            <p class="mb-2">â€¢ Canadian weather data: Environment and Climate Change Canada (Government of Canada) through Open-Meteo.com</p>
            <p class="text-xs mt-3 text-gray-500">Contains information licensed under Canada's Open Government Licence</p>
            <p class="text-xs text-gray-500">Wait times are estimates and may vary</p>
            <p class="text-xs text-gray-500">This is an unofficial third-party application and is not endorsed by any government agency</p>
        </div>
    </div>

    <script>
        // Crossing pairs configuration with coordinates and traffic cam URLs
        const CROSSING_PAIRS = [
            {
                header: 'Peace Arch crossing',
                subhead: 'Along Interstate 5 (I-5) in Washington and Highway 99 in British Columbia. No commercial vehicles (e.g., semis) allowed. Open 24/7.',
                usName: 'Blaine',
                usCrossing: 'Peace Arch',
                usDisplay: 'Blaine, WA',
                usLat: 49.0009,
                usLon: -122.7536,
                canadaFilter: 'Douglas',
                canadaDisplay: 'Surrey/Douglas/White Rock, BC',
                canadaLat: 49.0009,
                canadaLon: -122.7536,
                showUsCommercial: false,
                showCanadaCommercial: false,
                usCamUrl: 'https://www.drivebc.ca/images/13.jpg',
                usCamCaption: 'U.S.-bound traffic approaching the Peace Arch crossing',
                canadaCamUrl: 'https://images.wsdot.wa.gov/nw/005vc27650.jpg',
                canadaCamCaption: 'Canada-bound traffic approaching the Peace Arch crossing'
            },
            {
                header: 'Pacific Highway crossing',
                subhead: 'Along State Route 543 in Washington and Highway 15 in British Columbia (collectively referred to locally as Pacific Highway). Located about 1 mile east of the Peace Arch crossing. Commonly known as "the truck crossing," but it can also process passenger vehicles. Open 24/7.',
                usName: 'Blaine',
                usCrossing: 'Pacific Highway',
                usDisplay: 'Blaine, WA',
                usLat: 49.0020,
                usLon: -122.7353,
                canadaFilter: 'Pacific Highway',
                canadaDisplay: 'Surrey/Douglas/White Rock, BC',
                canadaLat: 49.0020,
                canadaLon: -122.7353,
                showUsCommercial: true,
                showCanadaCommercial: true,
                usCamUrl: 'https://www.drivebc.ca/images/15.jpg',
                usCamCaption: 'U.S.-bound traffic approaching the Pacific Highway crossing',
                canadaCamUrl: 'https://images.wsdot.wa.gov/nw/543vc00098.jpg?a=1771200010409',
                canadaCamCaption: 'Canada-bound traffic approaching the Pacific Highway crossing'
            },
            {
                header: 'Lynden crossing',
                subhead: 'Along State Route 539 (Guide Meridian Road) in Washington and Highway 13 (Diversion Street) in British Columbia. Open 8 a.m. to midnight.',
                usName: 'Lynden',
                usCrossing: null,
                usDisplay: 'Lynden, WA',
                usLat: 49.0019,
                usLon: -122.4852,
                canadaFilter: 'Aldergrove',
                canadaDisplay: 'Langley Township/Aldergrove, BC',
                canadaLat: 49.0019,
                canadaLon: -122.4852,
                showUsCommercial: true,
                showCanadaCommercial: true,
                usCamUrl: 'https://www.drivebc.ca/images/169.jpg?t=1771200048',
                usCamCaption: 'U.S.-bound traffic approaching the Lynden crossing',
                canadaCamUrl: 'https://images.wsdot.wa.gov/nw/539vc01510.jpg?a=1771200030629',
                canadaCamCaption: 'Canada-bound traffic approaching the Lynden crossing'
            },
            {
                header: 'Sumas crossing',
                subhead: 'Along State Route 9 (Cherry Street) in Washington and Highway 11 (Sumas Way) in British Columbia. Open 24/7.',
                usName: 'Sumas',
                usCrossing: null,
                usDisplay: 'Sumas, WA',
                usLat: 49.0022,
                usLon: -122.2654,
                canadaFilter: 'Abbotsford-Huntingdon',
                canadaDisplay: 'Abbotsford/Huntingdon, BC',
                canadaLat: 49.0022,
                canadaLon: -122.2654,
                showUsCommercial: true,
                showCanadaCommercial: true,
                usCamUrl: 'https://www.drivebc.ca/images/170.jpg',
                usCamCaption: 'U.S.-bound traffic approaching the Sumas crossing',
                canadaCamUrl: 'https://images.wsdot.wa.gov/nw/009vc09781.jpg?a=1771200235232',
                canadaCamCaption: 'Canada-bound traffic approaching the Sumas crossing'
            },
            {
                header: 'Point Roberts crossing',
                subhead: 'Along Tyee Drive in Point Roberts and 56th Street in Tsawwassen. Open 24/7.',
                usName: 'Blaine',
                usCrossing: 'Point Roberts',
                usDisplay: 'Point Roberts, WA',
                usLat: 49.0019,
                usLon: -123.0679,
                canadaFilter: 'Boundary Bay',
                canadaDisplay: 'Delta/Tsawwassen, BC',
                canadaLat: 49.0019,
                canadaLon: -123.0679,
                showUsCommercial: true,
                showCanadaCommercial: true,
                usCamUrl: null,
                canadaCamUrl: null
            }
        ];

        let canadaBound = [];
        let usBound = [];
        let weatherData = {};

        function hasCanadaData(port) {
            if (!port) return false;
            const hasStandard = port.travellersCanada && 
                               port.travellersCanada !== 'N/A' && 
                               port.travellersCanada !== '--' && 
                               port.travellersCanada !== 'Not Applicable';
            const hasCommercial = port.commercialCanada && 
                                 port.commercialCanada !== 'N/A' && 
                                 port.commercialCanada !== '--' && 
                                 port.commercialCanada !== 'Not Applicable';
            return hasStandard || hasCommercial;
        }

        function parseWaitTime(time) {
            if (!time || time === 'N/A' || time === '--' || time === 'Not Applicable') return -1;
            if (time === 'No Delay') return 0;
            
            const hourMatch = time.match(/(\d+)\s*(?:hour|hr|h)(?!:)/i);
            const minuteMatch = time.match(/(\d+)\s*(?:minute|min|m)(?!onth)/i);
            
            let totalMinutes = 0;
            
            if (hourMatch) {
                totalMinutes += parseInt(hourMatch[1]) * 60;
            }
            
            if (minuteMatch) {
                totalMinutes += parseInt(minuteMatch[1]);
            }
            
            if (totalMinutes === 0) {
                const match = time.match(/(\d+)/);
                if (match) {
                    totalMinutes = parseInt(match[1]);
                }
            }
            
            return totalMinutes > 0 ? totalMinutes : -1;
        }

        function formatWaitTime(time) {
            const minutes = parseWaitTime(time);
            if (minutes === -1) return 'N/A';
            if (minutes === 0) return 'No delay';
            if (minutes >= 60) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                if (mins === 0) {
                    return `${hours} ${hours === 1 ? 'hour' : 'hours'}`;
                }
                return `${hours} ${hours === 1 ? 'hour' : 'hours'} ${mins} min`;
            }
            return `${minutes} min`;
        }

        function getDelayColor(time) {
            const minutes = parseWaitTime(time);
            if (minutes === -1) return 'text-gray-400';
            if (minutes === 0) return 'text-green-600';
            if (minutes <= 15) return 'text-green-600';
            if (minutes <= 30) return 'text-yellow-600';
            return 'text-red-600';
        }

        function getWeatherEmoji(code) {
            if (code === 0) return 'â˜€ï¸';
            if (code === 1 || code === 2) return 'ðŸŒ¤ï¸';
            if (code === 3) return 'â˜ï¸';
            if (code >= 45 && code <= 48) return 'ðŸŒ«ï¸';
            if (code >= 51 && code <= 67) return 'ðŸŒ§ï¸';
            if (code >= 71 && code <= 77) return 'â„ï¸';
            if (code >= 80 && code <= 82) return 'ðŸŒ§ï¸';
            if (code >= 85 && code <= 86) return 'â„ï¸';
            if (code >= 95) return 'â›ˆï¸';
            return 'ðŸŒ¤ï¸';
        }

        function getWeatherDescription(code) {
            if (code === 0) return 'Clear sky';
            if (code === 1) return 'Mainly clear';
            if (code === 2) return 'Partly cloudy';
            if (code === 3) return 'Overcast';
            if (code >= 45 && code <= 48) return 'Foggy';
            if (code >= 51 && code <= 55) return 'Drizzle';
            if (code >= 56 && code <= 57) return 'Freezing drizzle';
            if (code >= 61 && code <= 65) return 'Rain';
            if (code >= 66 && code <= 67) return 'Freezing rain';
            if (code >= 71 && code <= 75) return 'Snow';
            if (code >= 77) return 'Snow grains';
            if (code >= 80 && code <= 82) return 'Rain showers';
            if (code >= 85 && code <= 86) return 'Snow showers';
            if (code >= 95) return 'Thunderstorm';
            return 'Partly cloudy';
        }

        async function fetchWeather() {
            try {
                const weatherPromises = CROSSING_PAIRS.map(async pair => {
                    const usUrl = `https://api.open-meteo.com/v1/forecast?latitude=${pair.usLat}&longitude=${pair.usLon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=America/Los_Angeles`;
                    const usResponse = await fetch(usUrl);
                    const usData = await usResponse.json();

                    const canadaUrl = `https://api.open-meteo.com/v1/forecast?latitude=${pair.canadaLat}&longitude=${pair.canadaLon}&current=temperature_2m,weather_code&temperature_unit=celsius&timezone=America/Vancouver`;
                    const canadaResponse = await fetch(canadaUrl);
                    const canadaData = await canadaResponse.json();

                    return {
                        pairIndex: CROSSING_PAIRS.indexOf(pair),
                        us: {
                            temp: Math.round(usData.current.temperature_2m),
                            code: usData.current.weather_code
                        },
                        canada: {
                            temp: Math.round(canadaData.current.temperature_2m),
                            code: canadaData.current.weather_code
                        }
                    };
                });

                const results = await Promise.all(weatherPromises);
                results.forEach(result => {
                    weatherData[result.pairIndex] = result;
                });
            } catch (error) {
                console.error('Error fetching weather:', error);
            }
        }

        function findUSPort(pair) {
            return usBound.find(port => {
                const nameMatch = port.name === pair.usName;
                const crossingMatch = pair.usCrossing ? port.crossing === pair.usCrossing : true;
                return nameMatch && crossingMatch;
            });
        }

        function findCanadaPort(pair) {
            return canadaBound.find(port => 
                port.office && port.office.includes(pair.canadaFilter)
            );
        }

        function renderUSCard(port, pair, pairIndex) {
            const trafficCamHtml = pair.usCamUrl 
                ? `
                    <div class="mt-3">
                        <img src="${pair.usCamUrl}" alt="Traffic camera" class="w-full rounded border border-gray-300" onerror="this.style.display='none'">
                        <p class="text-xs text-gray-500 mt-1">${pair.usCamCaption}</p>
                    </div>
                `
                : `<p class="text-xs text-gray-500 mt-3">No traffic cams posted at Point Roberts crossing</p>`;

            if (!port) {
                return `
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <img src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/svg/1f1fa-1f1f8.svg" 
                                         width="20" height="20" alt="US Flag" class="inline-block">
                                    <h3 class="font-semibold text-gray-900">${pair.usDisplay}</h3>
                                </div>
                                ${weatherData[pairIndex] ? `
                                <div class="flex items-center gap-2 text-xs text-gray-600 ml-7">
                                    <span class="text-lg">${getWeatherEmoji(weatherData[pairIndex].us.code)}</span>
                                    <span class="font-medium">${weatherData[pairIndex].us.temp}Â°F</span>
                                    <span class="text-gray-400">â€¢</span>
                                    <span>${getWeatherDescription(weatherData[pairIndex].us.code)}</span>
                                </div>
                                ` : ''}
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500">
                                No data
                            </span>
                        </div>
                        <p class="text-sm text-gray-500">Wait time data unavailable</p>
                        ${trafficCamHtml}
                    </div>
                `;
            }

            const isOpen = port.status === 'Open';
            
            return `
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <img src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/svg/1f1fa-1f1f8.svg" 
                                     width="20" height="20" alt="US Flag" class="inline-block">
                                <h3 class="font-semibold text-gray-900">${pair.usDisplay}</h3>
                            </div>
                            ${weatherData[pairIndex] ? `
                            <div class="flex items-center gap-2 text-xs text-gray-600 ml-7">
                                <span class="text-lg">${getWeatherEmoji(weatherData[pairIndex].us.code)}</span>
                                <span class="font-medium">${weatherData[pairIndex].us.temp}Â°F</span>
                                <span class="text-gray-400">â€¢</span>
                                <span>${getWeatherDescription(weatherData[pairIndex].us.code)}</span>
                            </div>
                            ` : ''}
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-medium ${isOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${port.status}
                        </span>
                    </div>
                    
                    <div class="grid ${pair.showUsCommercial ? 'grid-cols-3' : 'grid-cols-2'} gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Standard</p>
                            <p class="font-semibold ${getDelayColor(port.passengerDelay)}">
                                ${formatWaitTime(port.passengerDelay)}
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs mb-1">NEXUS</p>
                            <p class="font-semibold ${getDelayColor(port.nexusDelay)}">
                                ${formatWaitTime(port.nexusDelay)}
                            </p>
                        </div>
                        ${pair.showUsCommercial ? `
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Commercial</p>
                            <p class="font-semibold ${getDelayColor(port.commercialDelay)}">
                                ${formatWaitTime(port.commercialDelay)}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                    ${trafficCamHtml}
                </div>
            `;
        }

        function renderCanadaCard(port, pair, pairIndex) {
            const trafficCamHtml = pair.canadaCamUrl 
                ? `
                    <div class="mt-3">
                        <img src="${pair.canadaCamUrl}" alt="Traffic camera" class="w-full rounded border border-gray-300" onerror="this.style.display='none'">
                        <p class="text-xs text-gray-500 mt-1">${pair.canadaCamCaption}</p>
                    </div>
                `
                : `<p class="text-xs text-gray-500 mt-3">No traffic cams posted at Point Roberts crossing</p>`;

            if (!port || !hasCanadaData(port)) {
                return `
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <img src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/svg/1f1e8-1f1e6.svg" 
                                         width="20" height="20" alt="Canada Flag" class="inline-block">
                                    <h3 class="font-semibold text-gray-900">${pair.canadaDisplay}</h3>
                                </div>
                                ${weatherData[pairIndex] ? `
                                <div class="flex items-center gap-2 text-xs text-gray-600 ml-7">
                                    <span class="text-lg">${getWeatherEmoji(weatherData[pairIndex].canada.code)}</span>
                                    <span class="font-medium">${weatherData[pairIndex].canada.temp}Â°C</span>
                                    <span class="text-gray-400">â€¢</span>
                                    <span>${getWeatherDescription(weatherData[pairIndex].canada.code)}</span>
                                </div>
                                ` : ''}
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-500">
                                No data
                            </span>
                        </div>
                        <p class="text-sm text-gray-500">Wait time data unavailable</p>
                        ${trafficCamHtml}
                    </div>
                `;
            }
            
            return `
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <img src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/svg/1f1e8-1f1e6.svg" 
                                     width="20" height="20" alt="Canada Flag" class="inline-block">
                                <h3 class="font-semibold text-gray-900">${pair.canadaDisplay}</h3>
                            </div>
                            ${weatherData[pairIndex] ? `
                            <div class="flex items-center gap-2 text-xs text-gray-600 ml-7">
                                <span class="text-lg">${getWeatherEmoji(weatherData[pairIndex].canada.code)}</span>
                                <span class="font-medium">${weatherData[pairIndex].canada.temp}Â°C</span>
                                <span class="text-gray-400">â€¢</span>
                                <span>${getWeatherDescription(weatherData[pairIndex].canada.code)}</span>
                            </div>
                            ` : ''}
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">
                            Open
                        </span>
                    </div>
                    
                    <div class="grid ${pair.showCanadaCommercial ? 'grid-cols-3' : 'grid-cols-2'} gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Standard</p>
                            <p class="font-semibold ${getDelayColor(port.travellersCanada)}">
                                ${formatWaitTime(port.travellersCanada)}
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs mb-1">NEXUS</p>
                            <p class="font-semibold text-gray-400">
                                N/A
                            </p>
                        </div>
                        ${pair.showCanadaCommercial ? `
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Commercial</p>
                            <p class="font-semibold ${getDelayColor(port.commercialCanada)}">
                                ${formatWaitTime(port.commercialCanada)}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                    ${trafficCamHtml}
                </div>
            `;
        }

        function renderData() {
            const content = document.getElementById('content');
            
            content.innerHTML = CROSSING_PAIRS.map((pair, index) => {
                const usPort = findUSPort(pair);
                const canadaPort = findCanadaPort(pair);
                
                return `
                    <div>
                        <div class="mb-3 text-center">
                            <h2 class="text-lg font-bold text-gray-900 underline mb-1">${pair.header}</h2>
                            <p class="text-sm font-bold text-gray-600">${pair.subhead}</p>
                        </div>
                        <div class="grid md:grid-cols-2 gap-3 md:gap-4">
                            ${renderUSCard(usPort, pair, index)}
                            ${renderCanadaCard(canadaPort, pair, index)}
                        </div>
                        ${index < CROSSING_PAIRS.length - 1 ? '<div class="border-t-2 border-gray-200 my-6"></div>' : '<div class="border-t-2 border-gray-200 my-6"></div>'}
                    </div>
                `;
            }).join('');
        }

        async function fetchData() {
            const refreshIcon = document.getElementById('refreshIcon');
            const loadingState = document.getElementById('loadingState');
            const content = document.getElementById('content');
            const errorMessage = document.getElementById('errorMessage');
            
            refreshIcon.classList.add('animate-spin');
            errorMessage.classList.add('hidden');

            try {
                await fetchWeather();

                const cbsaUrl = encodeURIComponent('https://www.cbsa-asfc.gc.ca/bwt-taf/bwt-eng.csv');
                const cbsaRes = await fetch(`/.netlify/functions/border-data?url=${cbsaUrl}`);
                
                if (!cbsaRes.ok) throw new Error('Failed to fetch Canadian data');
                
                const cbsaText = await cbsaRes.text();
                const cbsaLines = cbsaText.split('\n').slice(1).filter(line => line.trim());
                
                canadaBound = cbsaLines.map(line => {
                    const parts = line.split(';;').map(p => p.trim());
                    return {
                        office: parts[0],
                        location: parts[1],
                        updated: parts[2],
                        commercialCanada: parts[3],
                        commercialUS: parts[4],
                        travellersCanada: parts[5],
                        travellersUS: parts[6],
                    };
                });

                const cbpUrl = encodeURIComponent('https://bwt.cbp.gov/xml/bwt.xml');
                const cbpRes = await fetch(`/.netlify/functions/border-data?url=${cbpUrl}`);
                
                if (!cbpRes.ok) throw new Error('Failed to fetch U.S. data');
                
                const cbpText = await cbpRes.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(cbpText, 'text/xml');
                
                const ports = Array.from(xml.querySelectorAll('port'));
                usBound = ports
                    .filter(port => port.querySelector('border')?.textContent === 'Canadian Border')
                    .map(port => {
                        const getDelay = (selector) => {
                            const elem = port.querySelector(selector);
                            return elem?.textContent || 'N/A';
                        };
                        
                        return {
                            name: port.querySelector('port_name')?.textContent,
                            crossing: port.querySelector('crossing_name')?.textContent,
                            updated: port.querySelector('date')?.textContent,
                            status: port.querySelector('port_status')?.textContent,
                            commercialDelay: getDelay('commercial_vehicle_lanes standard_lanes delay_minutes'),
                            passengerDelay: getDelay('passenger_vehicle_lanes standard_lanes delay_minutes'),
                            nexusDelay: getDelay('passenger_vehicle_lanes NEXUS_SENTRI_lanes delay_minutes'),
                        };
                    });

                loadingState.classList.add('hidden');
                content.classList.remove('hidden');
                
                const lastUpdate = document.getElementById('lastUpdate');
                const updateTime = document.getElementById('updateTime');
                lastUpdate.classList.remove('hidden');
                updateTime.textContent = new Date().toLocaleTimeString();

                renderData();
            } catch (error) {
                console.error('Error fetching data:', error);
                loadingState.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        fetchData();
        setInterval(fetchData, 300000);
    </script>
</body>
</html>
