<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whatcom County border crossing wait times</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        Whatcom County border crossing wait times
                    </h1>
                    <p class="text-gray-600">Real-time estimates for the five U.S.-Canada border crossings in Whatcom County, Washington</p>
                </div>
                <button onclick="fetchData()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            
            <div id="lastUpdate" class="flex items-center gap-2 text-sm text-gray-500 hidden">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Last updated: <span id="updateTime"></span>
            </div>

            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-800 font-semibold">Error loading data</p>
                <p class="text-red-600 text-sm mt-1" id="errorText"></p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="bg-white rounded-xl shadow-lg p-12 text-center">
            <svg class="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <p class="text-gray-600">Loading border wait times...</p>
        </div>

        <!-- Content - Paired Crossings -->
        <div id="content" class="hidden space-y-6">
            <!-- Pairs will be inserted here -->
        </div>

        <!-- Footer -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4 text-center text-sm text-gray-600">
            <p class="font-semibold mb-2">Data Sources & Attribution</p>
            <p>U.S.-bound data: U.S. Customs and Border Protection (CBP)</p>
            <p class="mb-2">Canada-bound data: Contains information licensed under the Open Government Licence ‚Äì Canada</p>
            <p class="text-xs mt-3 text-gray-500">Wait times are estimates and may vary.</p>
            <p class="text-xs text-gray-500">This is an unofficial third-party application and is not endorsed by CBP or CBSA.</p>
        </div>
    </div>

    <script>
        // Crossing pairs configuration
        const CROSSING_PAIRS = [
            {
                usName: 'Blaine',
                usCrossing: 'Peace Arch',
                usDisplay: 'Blaine, WA (Peace Arch)',
                canadaFilter: 'Douglas',
                canadaDisplay: 'Surrey, BC (Peace Arch)',
                showUsCommercial: false,
                showCanadaCommercial: false
            },
            {
                usName: 'Blaine',
                usCrossing: 'Pacific Highway',
                usDisplay: 'Blaine, WA (Pacific Highway)',
                canadaFilter: 'Pacific Highway',
                canadaDisplay: 'Surrey, BC (Pacific Highway)',
                showUsCommercial: true,
                showCanadaCommercial: true
            },
            {
                usName: 'Lynden',
                usCrossing: null,
                usDisplay: 'Lynden, WA',
                canadaFilter: 'Aldergrove',
                canadaDisplay: 'Aldergrove, BC / Lynden, WA',
                showUsCommercial: true,
                showCanadaCommercial: true
            },
            {
                usName: 'Sumas',
                usCrossing: null,
                usDisplay: 'Sumas, WA',
                canadaFilter: 'Abbotsford-Huntingdon',
                canadaDisplay: 'Abbotsford, BC / Sumas, WA',
                showUsCommercial: true,
                showCanadaCommercial: true
            },
            {
                usName: 'Blaine',
                usCrossing: 'Point Roberts',
                usDisplay: 'Point Roberts, WA',
                canadaFilter: 'Boundary Bay',
                canadaDisplay: 'Delta, BC / Point Roberts, WA',
                showUsCommercial: true,
                showCanadaCommercial: true
            }
        ];

        let canadaBound = [];
        let usBound = [];

        function parseWaitTime(time) {
            if (!time || time === 'N/A' || time === '--' || time === 'Not Applicable') return -1;
            if (time === 'No Delay') return 0;
            const match = time.match(/(\d+)/);
            return match ? parseInt(match[1]) : -1;
        }

        function formatWaitTime(time) {
            if (!time || time === 'N/A' || time === '--' || time === 'Not Applicable') return 'N/A';
            if (time === 'No Delay') return 'No delay';
            const mins = parseWaitTime(time);
            if (mins === 0) return 'No delay';
            if (mins > 0) return `${mins} min`;
            return time;
        }

        function getDelayColor(time) {
            const mins = parseWaitTime(time);
            if (mins < 0) return 'text-gray-400';
            if (mins === 0) return 'text-green-600';
            if (mins < 15) return 'text-yellow-600';
            if (mins < 30) return 'text-orange-600';
            return 'text-red-600';
        }

        function findUSPort(pair) {
            return usBound.find(port => {
                const nameMatch = port.name === pair.usName;
                const crossingMatch = !pair.usCrossing || port.crossing === pair.usCrossing;
                return nameMatch && crossingMatch;
            });
        }

        function findCanadaPort(pair) {
            return canadaBound.find(port => port.office.includes(pair.canadaFilter));
        }

        function renderUSCard(port, pair) {
            if (!port) return '<div class="bg-gray-100 rounded-lg p-4 text-gray-500">Data unavailable</div>';
            
            return `
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                </svg>
                                <h3 class="font-semibold text-gray-900">üóΩ ${pair.usDisplay}</h3>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                            port.status === 'Open' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                        }">
                            ${port.status}
                        </span>
                    </div>
                    
                    <div class="grid ${pair.showUsCommercial ? 'grid-cols-3' : 'grid-cols-2'} gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Standard</p>
                            <p class="font-semibold ${getDelayColor(port.passengerDelay)}">
                                ${formatWaitTime(port.passengerDelay)}
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-xs mb-1">NEXUS</p>
                            <p class="font-semibold ${getDelayColor(port.nexusDelay)}">
                                ${formatWaitTime(port.nexusDelay)}
                            </p>
                        </div>
                        ${pair.showUsCommercial ? `
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Commercial</p>
                            <p class="font-semibold ${getDelayColor(port.commercialDelay)}">
                                ${formatWaitTime(port.commercialDelay)}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderCanadaCard(port, pair) {
            if (!port) return '<div class="bg-gray-100 rounded-lg p-4 text-gray-500">Data unavailable</div>';
            
            return `
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                <h3 class="font-semibold text-gray-900">üçÅ ${pair.canadaDisplay}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid ${pair.showCanadaCommercial ? 'grid-cols-2' : 'grid-cols-1'} gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Travellers</p>
                            <p class="font-semibold ${getDelayColor(port.travellersCanada)}">
                                ${formatWaitTime(port.travellersCanada)}
                            </p>
                        </div>
                        ${pair.showCanadaCommercial ? `
                        <div>
                            <p class="text-gray-500 text-xs mb-1">Commercial</p>
                            <p class="font-semibold ${getDelayColor(port.commercialCanada)}">
                                ${formatWaitTime(port.commercialCanada)}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderData() {
            const content = document.getElementById('content');
            
            content.innerHTML = CROSSING_PAIRS.map(pair => {
                const usPort = findUSPort(pair);
                const canadaPort = findCanadaPort(pair);
                
                return `
                    <div class="grid md:grid-cols-2 gap-3 md:gap-4">
                        ${renderUSCard(usPort, pair)}
                        ${renderCanadaCard(canadaPort, pair)}
                    </div>
                `;
            }).join('');
        }

        async function fetchData() {
            const refreshIcon = document.getElementById('refreshIcon');
            const loadingState = document.getElementById('loadingState');
            const content = document.getElementById('content');
            const errorMessage = document.getElementById('errorMessage');
            
            refreshIcon.classList.add('animate-spin');
            errorMessage.classList.add('hidden');

            try {
                // Fetch Canada-bound data via Netlify Function
                const cbsaUrl = encodeURIComponent('https://www.cbsa-asfc.gc.ca/bwt-taf/bwt-eng.csv');
                const cbsaRes = await fetch(`/.netlify/functions/border-data?url=${cbsaUrl}`);
                
                if (!cbsaRes.ok) throw new Error('Failed to fetch Canadian data');
                
                const cbsaText = await cbsaRes.text();
                const cbsaLines = cbsaText.split('\n').slice(1).filter(line => line.trim());
                
                canadaBound = cbsaLines.map(line => {
                    const parts = line.split(';;').map(p => p.trim());
                    return {
                        office: parts[0],
                        location: parts[1],
                        updated: parts[2],
                        commercialCanada: parts[3],
                        commercialUS: parts[4],
                        travellersCanada: parts[5],
                        travellersUS: parts[6],
                    };
                });

                // Fetch U.S.-bound data via Netlify Function
                const cbpUrl = encodeURIComponent('https://bwt.cbp.gov/xml/bwt.xml');
                const cbpRes = await fetch(`/.netlify/functions/border-data?url=${cbpUrl}`);
                
                if (!cbpRes.ok) throw new Error('Failed to fetch U.S. data');
                
                const cbpText = await cbpRes.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(cbpText, 'text/xml');
                
                const ports = Array.from(xml.querySelectorAll('port'));
                usBound = ports
                    .filter(port => port.querySelector('border')?.textContent === 'Canadian Border')
                    .map(port => {
                        const getDelay = (selector) => {
                            const elem = port.querySelector(selector);
                            return elem?.textContent || 'N/A';
                        };
                        
                        return {
                            name: port.querySelector('port_name')?.textContent,
                            crossing: port.querySelector('crossing_name')?.textContent,
                            updated: port.querySelector('date')?.textContent,
                            status: port.querySelector('port_status')?.textContent,
                            commercialDelay: getDelay('commercial_vehicle_lanes standard_lanes delay_minutes'),
                            passengerDelay: getDelay('passenger_vehicle_lanes standard_lanes delay_minutes'),
                            nexusDelay: getDelay('passenger_vehicle_lanes NEXUS_SENTRI_lanes delay_minutes'),
                        };
                    });

                loadingState.classList.add('hidden');
                content.classList.remove('hidden');
                
                const lastUpdate = document.getElementById('lastUpdate');
                const updateTime = document.getElementById('updateTime');
                lastUpdate.classList.remove('hidden');
                updateTime.textContent = new Date().toLocaleTimeString();

                renderData();
            } catch (error) {
                console.error('Error fetching data:', error);
                loadingState.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        // Initial load
        fetchData();

        // Auto-refresh every 5 minutes
        setInterval(fetchData, 300000);
    </script>
</body>
</html>
